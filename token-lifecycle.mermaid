graph LR
    A["Token Generated<br/>JTI = UUID<br/>Type = access/refresh<br/>ExpiresAt = now + TTL"] --> B["JWT Signing<br/>alg: HS256<br/>key: global_secret +<br/>user.TokenKey"]
    
    B --> C["Token Issued<br/>to Client"]
    
    C --> D{"Token Usage"}
    
    D -->|With each request| E["Client sends<br/>Authorization: Bearer {token}"]
    
    E --> F["Server Validates<br/>1. Signature Check<br/>2. Expiry Check<br/>3. Type Check"]
    
    F --> G{"Validation<br/>Success?"}
    
    G -->|Yes| H{"Revocation<br/>Check Enabled?"}
    
    H -->|Yes| I["Query revoked_tokens<br/>WHERE jti = {jti}"]
    
    I --> J{"Token Revoked?"}
    
    J -->|No| K["Token Valid<br/>Inject Claims<br/>into Context"]
    
    J -->|Yes| L["Reject Request<br/>401 Unauthorized"]
    
    H -->|No| K
    
    G -->|No| M["Reject Request<br/>401 Unauthorized"]
    
    N["Token Expiration"] --> O["User calls /auth/logout<br/>or timeout reached"]
    
    O --> P["Extract JTI from token"]
    
    P --> Q["INSERT into revoked_tokens<br/>jti, user_id, expires_at<br/>reason: 'logout' or expired"]
    
    Q --> R["Token Blacklist<br/>Database"]
    
    R --> S["Future requests<br/>with this token<br/>rejected immediately"]