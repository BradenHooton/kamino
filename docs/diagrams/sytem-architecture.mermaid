graph TB
    subgraph "HTTP Layer"
        A["HTTP Router<br/>Chi"]
        B["Public Routes<br/>POST /auth/login<br/>POST /auth/register<br/>POST /auth/refresh"]
        C["Protected Routes<br/>Requires Auth Middleware"]
    end
    
    subgraph "Middleware Layer"
        D["Auth Middleware<br/>- Extract token<br/>- Validate signature<br/>- Check revocation<br/>- Inject claims"]
        E["Role Middleware<br/>- Validate user role<br/>- Enforce permissions<br/>- Return 403 if denied"]
    end
    
    subgraph "Business Logic"
        F["Auth Service<br/>- Login<br/>- Register<br/>- RefreshToken<br/>- Logout"]
        G["User Service<br/>- GetUser<br/>- UpdateUser<br/>- CreateUser"]
    end
    
    subgraph "Token Management"
        H["Token Manager<br/>- GenerateAccessToken<br/>- GenerateRefreshToken<br/>- ValidateToken<br/>- Composite Key Signing"]
    end
    
    subgraph "Data Layer"
        I["User Repository<br/>- GetByID<br/>- GetByEmail<br/>- Create<br/>- Update"]
        J["Token Revocation Repo<br/>- RevokeToken<br/>- IsTokenRevoked<br/>- RevokeAllUserTokens"]
    end
    
    subgraph "Database"
        K["Users Table<br/>id, email, password_hash<br/>name, email_verified, role<br/>status, locked_until<br/>password_changed_at, token_key"]
        L["Revoked Tokens Table<br/>id, jti, user_id<br/>token_type, expires_at<br/>reason"]
    end
    
    subgraph "Logging & Audit"
        M["Audit Logger<br/>- Log auth attempts<br/>- Track successes<br/>- Track failures"]
        N["slog Logger<br/>- Error logging<br/>- Info logging<br/>- Debug logging"]
    end
    
    A --> B
    A --> C
    C --> D
    C --> E
    D --> F
    E --> G
    F --> H
    G --> H
    H --> I
    H --> J
    I --> K
    J --> L
    F --> M
    F --> N
    G --> N